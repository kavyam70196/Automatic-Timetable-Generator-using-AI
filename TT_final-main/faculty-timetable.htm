<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Schedule - MIT Mysore</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            color: white;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(30, 64, 175, 0.3);
        }
        
        .header-text {
            flex: 1;
            text-align: center;
            padding: 0 25px;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        
        .btn-back { background: linear-gradient(135deg, #28a745, #20c997); color: white; }
        .btn-download { background: linear-gradient(135deg, #007bff, #0056b3); color: white; }
        
        .faculty-selector {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid #e3e6f0;
        }
        
        .faculty-selector h3 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        select {
            padding: 12px 15px;
            border: 2px solid #e3e6f0;
            border-radius: 8px;
            font-size: 14px;
            margin-right: 15px;
            margin-bottom: 10px;
            min-width: 200px;
            transition: all 0.3s ease;
        }
        
        select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .faculty-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .faculty-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        
        .faculty-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }
        
        .faculty-name {
            font-size: 16px;
            font-weight: bold;
            color: #1e40af;
            margin-bottom: 8px;
        }
        
        .faculty-info {
            color: #64748b;
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .btn-view {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-view:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .timetable-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            overflow-x: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid #e3e6f0;
        }
        
        .timetable {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .timetable th, .timetable td {
            border: 2px solid #e3e6f0;
            padding: 12px 8px;
            text-align: center;
            font-size: 12px;
            vertical-align: middle;
        }
        
        .timetable th {
            background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
            font-weight: bold;
            color: white;
            font-size: 13px;
        }
        
        .period-slot {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 8px;
            padding: 10px 6px;
            margin: 3px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            border-left: 4px solid #3b82f6;
            transition: all 0.3s ease;
        }
        
        .subject-name {
            font-weight: bold;
            color: #1e40af;
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .section-info {
            color: #64748b;
            font-size: 10px;
            margin: 2px 0;
            font-weight: 500;
        }
        
        .room-info {
            color: #059669;
            font-size: 10px;
            font-weight: bold;
            background: #ecfdf5;
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 2px;
        }
        
        .lab-session {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-left: 4px solid #10b981;
        }
        
        .free-period {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #64748b;
            font-style: italic;
            border-left: 4px solid #94a3b8;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .no-schedule {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .schedule-summary {
            background: linear-gradient(135deg, #dbeafe 0%, #f0f9ff 100%);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            border: 2px solid #3b82f6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.2);
        }
        
        .schedule-summary h4 {
            color: #1e40af;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 700;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .summary-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center; color: white;">
            <div class="loading-spinner"></div>
            <div style="margin-top: 20px; font-size: 18px; font-weight: bold;">Loading Schedule...</div>
        </div>
    </div>

    <div class="header">
        <img src="left-logo.png" alt="MET Logo" style="height: 70px; width: 70px; border-radius: 50%; border: 2px solid #000;">
        <div class="header-text">
            <h1>üìÖ MY SCHEDULE</h1>
            <p><strong>Faculty Timetable Viewer</strong></p>
        </div>
        <img src="right-logo.png" alt="MIT Logo" style="height: 70px; width: 70px; border-radius: 50%; border: 2px solid #000;">
    </div>

    <div class="controls">
        <button class="control-btn btn-back" onclick="goBack()">‚Üê Back</button>
        <button class="control-btn btn-download" onclick="downloadSchedule()" id="downloadBtn" style="display: none;">üì• Download PDF</button>
    </div>

    <div class="faculty-selector">
        <h3>Faculty Timetables</h3>
        <div style="margin-top: 15px;">
            <select id="academicYearSelect" onchange="loadFaculty()">
                <option value="">--Select Academic Year--</option>
            </select>
        </div>
    </div>

    <div id="facultyList" style="display: none;">
        <h3 style="color: #1e40af; margin: 20px 0;">Available Faculty</h3>
        <div id="facultyCards" class="faculty-grid"></div>
    </div>

    <div class="timetable-container" id="timetableContainer" style="display: none;">
        <div class="schedule-summary" id="scheduleSummary"></div>
        <table class="timetable" id="timetableTable">
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Tuesday</th>
                    <th>Wednesday</th>
                    <th>Thursday</th>
                    <th>Friday</th>
                    <th>Saturday</th>
                </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
        </table>
    </div>

    <div class="no-schedule" id="noSchedule" style="display: none;">
        <h3>No Schedule Found</h3>
        <p>Please select a faculty member and academic year to view the schedule.</p>
    </div>

    <script>
        const SUPABASE_URL = 'https://bkmzyhroignpjebfpqug.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJrbXp5aHJvaWducGplYmZwcXVnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MjA1NDUsImV4cCI6MjA3Mjk5NjU0NX0.ICE2eYzFZvz0dtNpAa5YlJTZD-idc2J76wn1ZeHwwck';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        const timeSlots = [
            { id: 1, name: 'Period 1', time: '09:00 - 10:00' },
            { id: 2, name: 'Period 2', time: '10:00 - 11:00' },
            { id: 3, name: 'Period 3', time: '11:15 - 12:15' },
            { id: 4, name: 'Period 4', time: '12:15 - 13:15' },
            { id: 5, name: 'Period 5', time: '14:00 - 15:00' },
            { id: 6, name: 'Period 6', time: '15:00 - 16:00' }
        ];

        const days = ['Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        document.addEventListener('DOMContentLoaded', loadAcademicYears);

        async function loadAcademicYears() {
            try {
                const { data, error } = await supabase
                    .from('timetables')
                    .select('academic_year')
                    .not('academic_year', 'is', null);
                
                if (error) throw error;

                const uniqueYears = [...new Set(data.map(item => item.academic_year))];
                const yearSelect = document.getElementById('academicYearSelect');
                yearSelect.innerHTML = '<option value="">--Select Academic Year--</option>';
                
                uniqueYears.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading academic years:', error);
            }
        }

        async function loadFaculty() {
            const academicYear = document.getElementById('academicYearSelect').value;
            if (!academicYear) {
                document.getElementById('facultyList').style.display = 'none';
                return;
            }
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                const { data: timetableData, error } = await supabase
                    .from('timetables')
                    .select('faculty_name, department')
                    .eq('academic_year', academicYear)
                    .eq('is_finalized', true);
                
                if (error) throw error;
                
                const facultyNames = [...new Set(timetableData?.map(t => t.faculty_name) || [])];
                
                const { data: facultyData, error: facultyError } = await supabase
                    .from('faculty')
                    .select('*')
                    .in('name', facultyNames)
                    .order('name');
                
                if (facultyError) throw facultyError;

                const facultyCards = document.getElementById('facultyCards');
                facultyCards.innerHTML = '';
                
                if (!facultyData || facultyData.length === 0) {
                    facultyCards.innerHTML = `
                        <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #64748b;">
                            <h3>No Faculty Timetables Found</h3>
                            <p>No finalized timetables found for academic year ${academicYear}.</p>
                        </div>
                    `;
                    document.getElementById('facultyList').style.display = 'block';
                    return;
                }
                
                facultyData.forEach(faculty => {
                    const card = document.createElement('div');
                    card.className = 'faculty-card';
                    card.innerHTML = `
                        <div class="faculty-name">${faculty.name}</div>
                        <div class="faculty-info">${faculty.initials} | ${faculty.designation?.replace('_', ' ') || 'Faculty'}</div>
                        <div class="faculty-info">${faculty.department}</div>
                        <div style="margin-top: 10px;">
                            <button class="btn-view" onclick="viewFacultyTimetable('${faculty.name}', '${academicYear}')">üìÖ View Timetable</button>
                        </div>
                    `;
                    facultyCards.appendChild(card);
                });
                
                document.getElementById('facultyList').style.display = 'block';
            } catch (error) {
                console.error('Error loading faculty:', error);
                alert('Error loading faculty: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        async function viewFacultyTimetable(facultyName, academicYear) {
            document.getElementById('loadingOverlay').style.display = 'flex';

            try {
                // ONLY load finalized timetables from vault
                const { data, error } = await supabase
                    .from('timetables')
                    .select('*')
                    .eq('faculty_name', facultyName)
                    .eq('academic_year', academicYear)
                    .eq('is_finalized', true)
                    .order('day')
                    .order('time_slot');
                
                if (error) throw error;

                if (data && data.length > 0) {
                    displaySchedule(data, facultyName);
                    document.getElementById('timetableContainer').style.display = 'block';
                    document.getElementById('noSchedule').style.display = 'none';
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    window.currentFaculty = { name: facultyName, academicYear: academicYear };
                } else {
                    document.getElementById('timetableContainer').style.display = 'none';
                    document.getElementById('noSchedule').style.display = 'block';
                    document.getElementById('downloadBtn').style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading schedule:', error);
                alert('Error loading schedule: ' + error.message);
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        function displaySchedule(scheduleData, facultyName) {
            // Create enhanced.htm style timetable
            const container = document.getElementById('timetableContainer');
            
            // Get faculty department
            const facultyDept = scheduleData.length > 0 ? scheduleData[0].department : 'Department';
            const academicYear = scheduleData.length > 0 ? scheduleData[0].academic_year : '2024-25';
            
            container.innerHTML = `
                <div style="background: white; border: 4px solid #000; border-radius: 15px; overflow: hidden; margin-bottom: 20px;">
                    <div style="display: flex; align-items: center; padding: 20px; background: linear-gradient(135deg, #004085 0%, #0056b3 50%, #004085 100%); color: white; border-bottom: 3px solid #000;">
                        <img src="left-logo.png" alt="MET Logo" style="height: 70px; width: 70px; border-radius: 50%; border: 2px solid #000;">
                        <div style="flex: 1; text-align: center; padding: 0 25px;">
                            <h1 style="font-size: 20px; font-weight: bold; margin-bottom: 8px;">MAHARAJA INSTITUTE OF TECHNOLOGY, MYSORE</h1>
                            <p style="font-size: 13px; margin: 4px 0; opacity: 0.95;"><strong>BELAWADI, SRIRANGAPATNA TALUK, MANDYA-571477</strong></p>
                            <p style="font-size: 13px; margin: 4px 0; opacity: 0.95;"><strong>FACULTY TIMETABLE - ${facultyDept.toUpperCase()}</strong></p>
                        </div>
                        <img src="right-logo.png" alt="MIT Logo" style="height: 70px; width: 70px; border-radius: 50%; border: 2px solid #000;">
                    </div>
                    
                    <div style="display: flex; justify-content: space-around; padding: 18px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); font-size: 15px; font-weight: bold; color: #1e3c72; border-bottom: 3px solid #000;">
                        <span>Faculty: <strong>${facultyName}</strong></span>
                        <span>Department: <strong>${facultyDept}</strong></span>
                        <span>Academic Year: <strong>${academicYear}</strong></span>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0; border: 3px solid #000;">
                        <thead>
                            <tr>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 13px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color: #1e3c72; font-weight: bold;">Day/Period</th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: linear-gradient(135deg, #e6e6e6 0%, #d4d4d4 100%); font-weight: 600;">Period 1<br><small>09:00-10:00</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: linear-gradient(135deg, #e6e6e6 0%, #d4d4d4 100%); font-weight: 600;">Period 2<br><small>10:00-11:00</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: #fff3cd; color: #856404; font-weight: 600;">TEA BREAK<br><small>11:00-11:15</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: linear-gradient(135deg, #e6e6e6 0%, #d4d4d4 100%); font-weight: 600;">Period 3<br><small>11:15-12:15</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: linear-gradient(135deg, #e6e6e6 0%, #d4d4d4 100%); font-weight: 600;">Period 4<br><small>12:15-13:15</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: #f8d7da; color: #721c24; font-weight: 600;">LUNCH BREAK<br><small>13:15-14:00</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: linear-gradient(135deg, #e6e6e6 0%, #d4d4d4 100%); font-weight: 600;">Period 5<br><small>14:00-15:00</small></th>
                                <th style="border: 2px solid #000; padding: 12px; text-align: center; font-size: 12px; background: linear-gradient(135deg, #e6e6e6 0%, #d4d4d4 100%); font-weight: 600;">Period 6<br><small>15:00-16:00</small></th>
                            </tr>
                        </thead>
                        <tbody id="facultyTimetableBody">
                        </tbody>
                    </table>
                    
                    <!-- Subject Information Table -->
                    <table style="width: 100%; border-collapse: collapse; margin-top: 20px; border: 2px solid #000;">
                        <thead>
                            <tr style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);">
                                <th style="border: 2px solid #000; padding: 8px; font-size: 12px; font-weight: bold;">SUB CODE</th>
                                <th style="border: 2px solid #000; padding: 8px; font-size: 12px; font-weight: bold;">SUBJECT TITLE</th>
                                <th style="border: 2px solid #000; padding: 8px; font-size: 12px; font-weight: bold;">DEPARTMENT</th>
                                <th style="border: 2px solid #000; padding: 8px; font-size: 12px; font-weight: bold;">SECTION</th>
                                <th style="border: 2px solid #000; padding: 8px; font-size: 12px; font-weight: bold;">REMARKS</th>
                            </tr>
                        </thead>
                        <tbody id="facultySubjectTable">
                        </tbody>
                    </table>
                </div>
            `;
            
            // Populate timetable data
            const schedule = {};
            days.forEach(day => {
                schedule[day] = {};
                timeSlots.forEach(slot => {
                    schedule[day][slot.id] = null;
                });
            });

            scheduleData.forEach(entry => {
                if (schedule[entry.day]) {
                    schedule[entry.day][entry.time_slot] = entry;
                }
            });

            const tbody = document.getElementById('facultyTimetableBody');
            tbody.innerHTML = '';

            days.forEach(day => {
                const row = document.createElement('tr');
                
                // Day header
                const dayCell = document.createElement('td');
                dayCell.innerHTML = day.toUpperCase();
                dayCell.style.cssText = 'background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); font-weight: bold; writing-mode: vertical-rl; text-orientation: mixed; width: 80px; font-size: 14px; color: #1e3c72; border: 2px solid #000; text-align: center;';
                row.appendChild(dayCell);

                // Period cells
                [1, 2, 'TEA', 3, 4, 'LUNCH', 5, 6].forEach((period, index) => {
                    const cell = document.createElement('td');
                    
                    if (period === 'TEA') {
                        cell.innerHTML = 'TEA BREAK';
                        cell.style.cssText = 'writing-mode: vertical-rl; text-orientation: mixed; font-weight: bold; font-size: 9px; background: #fff3cd; color: #856404; border: 2px solid #000; line-height: 1.2; text-align: center;';
                    } else if (period === 'LUNCH') {
                        cell.innerHTML = 'LUNCH BREAK';
                        cell.style.cssText = 'writing-mode: vertical-rl; text-orientation: mixed; font-weight: bold; font-size: 9px; background: #f8d7da; color: #721c24; border: 2px solid #000; line-height: 1.2; text-align: center;';
                    } else {
                        const entry = schedule[day][period];
                        cell.style.cssText = 'background: white; cursor: pointer; transition: all 0.3s ease; min-height: 70px; position: relative; padding: 8px 6px; border: 2px solid #000; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); text-align: center; vertical-align: middle;';
                        
                        if (entry) {
                            const subjectDisplay = entry.subject_code === 'FREE' ? 'FREE' : (entry.subject_name || entry.subject_code);
                            const isLab = entry.type === 'lab';
                            const facultyInitials = entry.faculty_name ? entry.faculty_name.split(' ').map(n => n[0]).join('') : '';
                            
                            // Get time slot info
                            const timeSlot = timeSlots.find(t => t.id === period);
                            const timeDisplay = timeSlot ? timeSlot.time : '';
                            
                            if (entry.subject_code === 'FREE') {
                                cell.innerHTML = `
                                    <div style="font-weight: bold; color: #6c757d; font-size: 12px; margin-bottom: 4px;">FREE</div>
                                    <div style="font-size: 9px; color: #6c757d; font-weight: 500;">${timeDisplay}</div>
                                `;
                                cell.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                                cell.style.color = '#64748b';
                                cell.style.fontStyle = 'italic';
                                cell.style.borderLeft = '4px solid #94a3b8';
                            } else if (isLab) {
                                cell.innerHTML = `
                                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 4px; color: #495057;">${subjectDisplay} LAB</div>
                                    <div style="font-size: 9px; color: #6c757d; font-weight: 600; margin-bottom: 2px;">${entry.department} - Sec ${entry.section}</div>
                                    <div style="font-size: 8px; color: #059669; font-weight: bold; background: #ecfdf5; padding: 1px 4px; border-radius: 3px; display: inline-block; margin-bottom: 2px;">${entry.room}</div>
                                    <div style="font-size: 8px; color: #6c757d; font-weight: 500;">${timeDisplay}</div>
                                `;
                                cell.style.background = 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)';
                                cell.style.borderLeft = '4px solid #10b981';
                            } else {
                                cell.innerHTML = `
                                    <div style="font-weight: bold; font-size: 11px; margin-bottom: 4px; color: #1565c0;">${subjectDisplay}</div>
                                    <div style="font-size: 9px; color: #1976d2; font-weight: 600; margin-bottom: 2px;">${entry.department} - Sec ${entry.section}</div>
                                    <div style="font-size: 8px; color: #059669; font-weight: bold; background: #ecfdf5; padding: 1px 4px; border-radius: 3px; display: inline-block; margin-bottom: 2px;">${entry.room}</div>
                                    <div style="font-size: 8px; color: #1976d2; font-weight: 500;">${timeDisplay}</div>
                                `;
                                cell.style.background = 'linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%)';
                                cell.style.borderLeft = '4px solid #007bff';
                            }
                        } else {
                            const timeSlot = timeSlots.find(t => t.id === period);
                            const timeDisplay = timeSlot ? timeSlot.time : '';
                            cell.innerHTML = `
                                <div style="font-weight: bold; color: #6c757d; font-size: 12px; margin-bottom: 4px;">FREE</div>
                                <div style="font-size: 9px; color: #6c757d; font-weight: 500;">${timeDisplay}</div>
                            `;
                            cell.style.background = 'linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%)';
                            cell.style.color = '#64748b';
                            cell.style.fontStyle = 'italic';
                            cell.style.borderLeft = '4px solid #94a3b8';
                        }
                    }
                    
                    row.appendChild(cell);
                });

                tbody.appendChild(row);
            });
            
            // Populate subject information table
            populateFacultySubjectInfo(scheduleData);
        }
        
        function populateFacultySubjectInfo(scheduleData) {
            const subjectMap = new Map();
            
            scheduleData.forEach(entry => {
                if (entry.subject_code && entry.subject_code !== 'FREE') {
                    const key = `${entry.subject_code}-${entry.department}-${entry.section}`;
                    if (!subjectMap.has(key)) {
                        subjectMap.set(key, {
                            code: entry.subject_code,
                            name: entry.subject_name || entry.subject_code,
                            department: entry.department,
                            section: entry.section,
                            type: entry.type || 'theory'
                        });
                    }
                }
            });
            
            const tableBody = document.getElementById('facultySubjectTable');
            if (tableBody) {
                const sortedSubjects = Array.from(subjectMap.values()).sort((a, b) => a.code.localeCompare(b.code));
                const rows = sortedSubjects.map(subject => `
                    <tr>
                        <td style="border: 2px solid #000; padding: 6px; font-size: 11px; text-align: center; font-weight: bold;">${subject.code}</td>
                        <td style="border: 2px solid #000; padding: 6px; font-size: 11px;">${subject.name}</td>
                        <td style="border: 2px solid #000; padding: 6px; font-size: 11px; text-align: center;">${subject.department}</td>
                        <td style="border: 2px solid #000; padding: 6px; font-size: 11px; text-align: center;">${subject.section}</td>
                        <td style="border: 2px solid #000; padding: 6px; font-size: 11px; text-align: center;">${subject.type.toUpperCase()}</td>
                    </tr>
                `).join('');
                tableBody.innerHTML = rows;
            }
        }

        function downloadSchedule() {
            if (!window.currentFaculty) {
                alert('Please view a faculty timetable first');
                return;
            }
            window.print();
        }

        function goBack() {
            const urlParams = new URLSearchParams(window.location.search);
            const dept = urlParams.get('dept') || localStorage.getItem('currentDepartment');
            window.location.href = `page.htm?dept=${encodeURIComponent(dept)}`;
        }
    </script>
</body>
</html>